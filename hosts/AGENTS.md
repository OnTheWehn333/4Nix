# hosts/

Host-specific configurations and shared cross-host data.

## Structure

```
hosts/
├── pc-hylia/              # macOS (aarch64-darwin)
│   ├── configuration.nix  # System: nix-darwin settings, SSH, system packages
│   ├── home.nix           # HM: module imports, sops config, GPG/git keys
│   └── home-bootstrap.nix # Minimal HM: keysync + home-manager only
├── server-tenoko/         # NixOS (x86_64-linux)
│   ├── configuration.nix  # System: boot, users, SSH, bash→nushell auto-exec
│   ├── home.nix           # HM: module imports, sops config, GPG/git keys
│   ├── home-bootstrap.nix # Minimal HM: keysync + home-manager only
│   └── hardware-configuration.nix  # Auto-generated — DO NOT EDIT
└── shared/                # Plain attrsets (NOT modules), imported by both hosts
    ├── gpg-signing-keys.nix    # { pc-hylia = "..."; server-tenoko = "..."; }
    ├── gpg-ssh-keygrips.nix    # Per-host SSH auth keygrips
    └── ssh-public-keys.nix     # Per-host SSH public keys (for authorized_keys)
```

## Where to Look

| Task | File | Notes |
|------|------|-------|
| Add macOS-only module | `pc-hylia/home.nix` imports | Add to imports list |
| Add NixOS-only module | `server-tenoko/home.nix` imports | Add to imports list |
| Change system packages | `{host}/configuration.nix` | `environment.systemPackages` |
| Add SSH authorized key | `{host}/configuration.nix` | Uses `shared/ssh-public-keys.nix` |
| Change GPG signing key | `shared/gpg-signing-keys.nix` | Both hosts share same signing key |
| Add new host | Copy existing host dir, add entries in `flake.nix` | Need both normal + bootstrap configs |

## Conventions

- `home.nix` imports sops-nix variant matching platform: `sops-nix` (Linux) vs `sops-nix-darwin` (macOS)
- Shared data files use plain attrsets (`{ key = "value"; }`), NOT module functions
- GPG fingerprints live ONLY in `shared/*.nix` — never hardcoded in host configs
- `sops.defaultSopsFile` points to `../../secrets/{host}/secrets.yaml`
- Bootstrap configs import only `keysync.nix` + `home-manager` — for first-time key restore

## Host Differences

| Feature | pc-hylia | server-tenoko |
|---------|----------|---------------|
| Platform | nix-darwin | NixOS |
| Shell | zsh (native) | bash → nushell (auto-exec) |
| Extra modules | ghostty, tunnel9, atac, scrcpy, android-tools, agenix, chafa | — |
| opencode | `custom.opencode.useLatest = true` | `programs.opencode.enable = true` |
| Services | SSH | tak-server (Docker), SSH |

## Anti-Patterns

- **NEVER** edit `hardware-configuration.nix` — auto-generated by NixOS
- **DO NOT** hardcode GPG fingerprints — use `shared/*.nix`
- **DO NOT** add sops secrets without updating `.sops.yaml` path regex + PGP key
